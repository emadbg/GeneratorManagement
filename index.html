<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .login-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    .form-group {
      margin-bottom: 15px;
      position: relative;
    }
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .btn {
      display: inline-block;
      padding: 10px 15px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .btn:hover {
      background: #3367d6;
    }
    .hidden {
      display: none;
    }
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      background: #f1f1f1;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }
    .tab-button.active {
      background: #4285f4;
      color: white;
    }
    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #searchResults {
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      position: absolute;
      width: calc(100% - 2px);
      z-index: 1000;
      display: none;
    }
    .client-result {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .client-result:hover {
      background-color: #f5f5f5;
    }

    /* MODIFIED: Reduced width to prevent cutting off on the right side */
    #receipt {
      width: 76mm; /* Reduced from 80mm to create a safe margin */
      padding: 4px;
      font-size: 13px;
      line-height: 1.4;
      margin: 20px auto;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      font-family: Arial, sans-serif;
      box-sizing: border-box;
      direction: rtl; /* ADDED: RTL direction for Arabic */
    }
    .receipt-header {
      text-align: center;
      font-weight: bold;
      margin: 1px 0;
      padding: 0;
      font-size: 15px;
      line-height: 1.3;
    }
    .receipt-line {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
    }
    .receipt-label {
      font-weight: normal;
      white-space: nowrap;
      margin-left: 10px; /* CHANGED: from margin-right to margin-left for RTL */
      text-align: right; /* CHANGED: for RTL */
    }
    .receipt-value {
      text-align: left; /* CHANGED: for RTL */
    }
    .receipt-value.arabic {
      direction: rtl;
      text-align: left; /* CHANGED: for RTL */
    }
    .receipt-divider {
      border-top: 1px dotted #000;
      margin: 6px 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: right;
    }
    th {
      background: #f2f2f2;
    }
    th:first-child, td:first-child {
        text-align: left;
    }
    #paymentForm table {
        width: 100%;
    }
    #paymentForm table th {
        width: 40%;
        text-align: left;
    }
    #paymentForm table td {
        width: 60%;
        text-align: right;
    }
    #paymentForm table tr:first-child td {
        text-align: left;
        font-weight: bold;
    }
    #clientsTab table th.client-col,
    #clientsTab table td.client-col {
        width: 25%;
        text-align: left;
    }
    #clientsTab table th.num-col,
    #clientsTab table td.num-col {
        width: 10%;
        text-align: right;
    }
    #clientsTab table th.paid-by-col,
    #clientsTab table td.paid-by-col {
        width: 15%;
        text-align: left;
    }
    #clientsTab table th.action-col,
    #clientsTab table td.action-col {
        width: 10%;
        text-align: center;
    }
    .total-row {
        font-weight: bold;
        background-color: #e9e9f9;
    }
    .status-message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .status-info {
      background: #e7f3fe;
      color: #0c5460;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
    }
    .total-due-highlight {
        font-weight: bold;
        color: red;
        font-size: 1.2em;
    }
    .filter-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-group label {
        white-space: nowrap;
    }
    .summary-stats {
        background-color: #e0f2f7;
        border: 1px solid #b2ebf2;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .summary-stats p {
        margin: 5px 0;
        font-size: 0.95em;
        color: #01579b;
    }
    .summary-stats p strong {
        font-size: 1.1em;
        color: #007bb5;
    }
    .summary-stats .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }
    .filter-item {
        display: flex;
        align-items: center;
        gap: 5px;
        flex: 1;
        min-width: 200px;
    }
    .filter-item input.form-control,
    .filter-item select.form-control {
        flex-grow: 1;
    }
    /* Updated Payments List Tab Styles */
      #paymentsListTab .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
        align-items: end;
      }
      #paymentsListTab .filters input, 
      #paymentsListTab .filters button {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        box-sizing: border-box;
      }
      #paymentsListTab .filters button {
        padding: 8px 12px;
      }
      #paymentsListTab table th:nth-child(2), /* Client Name column */
      #paymentsListTab table td:nth-child(2) {
        width: 30%;
        text-align: left;
      }
      #paymentsListTab table th:nth-child(3), /* Date column */
      #paymentsListTab table td:nth-child(3) {
        width: 15%;
      }
      #paymentsListTab table th:nth-child(4), /* User column */
      #paymentsListTab table td:nth-child(4) {
        width: 12%;
        text-align: left;
      }
      #paymentsListTab table th:nth-child(1), /* Payment ID column */
      #paymentsListTab table td:nth-child(1) {
        width: 8%;
        font-size: 11px;
        text-align: center;
      }
      #paymentsListTab table th:nth-child(5), /* Previous Balance column */
      #paymentsListTab table td:nth-child(5),
      #paymentsListTab table th:nth-child(6), /* Total Due Before column */
      #paymentsListTab table td:nth-child(6),
      #paymentsListTab table th:nth-child(7), /* Payment Amount column */
      #paymentsListTab table td:nth-child(7),
      #paymentsListTab table th:nth-child(8), /* New Balance column */
      #paymentsListTab table td:nth-child(8),
      #paymentsListTab table th:nth-child(9), /* Action column */
       #paymentsListTab table td:nth-child(9) {
        width: 10%;
        text-align: right;
    }
      #paymentsSummary {
        font-weight: bold;
        text-align: right;
        margin-bottom: 10px;
        font-size: 16px;
        color: #444;
      }
      #paymentsListTab tr:nth-child(even) {
        background-color: #f7f7f7;
      }
      #paymentsListTab .date-cell {
        font-size: 12px;
        color: #555;
      }
      #paymentsListTab .payment-id-cell {
        font-size: 11px;
        text-align: center;
      }
      
    /* MODIFIED: Enhanced print settings for 80mm paper */
    @media print {
      body, html {
        width: 80mm;
        margin: 0;
        padding: 0;
        background: white;
      }
      body * {
        visibility: hidden;
      }
      #receipt, #receipt * {
        visibility: visible;
      }
      #receipt {
        position: absolute;
        left: 0;
        top: 0;
        width: 76mm; /* Reduced width to prevent cutting off */
        margin: 0;
        padding: 4px;
        border: none;
        box-shadow: none;
        font-family: Arial, sans-serif;
        page-break-inside: avoid;
        box-sizing: border-box;
        direction: rtl; /* ADDED: RTL direction for Arabic in print */
      }
    }
</style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

  <div id="loginContainer" class="login-container">
    <div class="login-form">
      <h2>Generator Payments Login</h2>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="username" class="form-control" placeholder="Enter username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" class="form-control" placeholder="Enter password">
      </div>
      <button id="loginBtn" class="btn">Login</button>
      <div id="loginStatus" class="status-message"></div>
    </div>
  </div>

  <div id="mainApp" class="container hidden">
    <h1>Generator Subscription Payment **Loading...**</h1>

  <div class="tab-buttons">
        <button class="tab-button active" data-tab="paymentTab">New Payment</button>
        <button class="tab-button" data-tab="clientsTab">All Clients</button>
        <button class="tab-button" data-tab="paymentsListTab">Payments List</button>
        
        <!-- Users tab - only show if user is admin -->
        <button class="tab-button" data-tab="usersTab" id="usersTabButton" style="display: none;">Users</button>
        
        <button id="logoutBtn" class="btn" style="margin-left: auto;">Logout</button>
    </div>

    <div id="paymentTab" class="tab-content">
      <h2>New Payment</h2>
      <div class="form-group">
        <label>Search Client</label>
        <input type="text" id="clientSearch" class="form-control" placeholder="Type client name...">
        <div id="searchResults"></div>
      </div>

      <div id="paymentForm" class="hidden">
        <h3>Client Details</h3>
        <table>
          <tr><th>Client Name</th><td><span id="clientName"></span></td></tr>
          <tr id="monthlyFeeRow"><th>Monthly Fee</th><td><span id="monthlyFee"></span></td></tr>
          <tr id="prevCounterRow"><th>Previous Counter</th><td><span id="prevCounter"></span></td></tr>
           <tr id="currentCounterRow"><th>Current Counter</th><td><span id="currentCounter"></span></td></tr>
          <tr id="totalUsageRow"><th>Total Usage</th><td><span id="totalUsage"></span></td></tr>
          <tr id="kiloWattPriceRow"><th>KiloWatt Price</th><td><span id="kiloWattPrice"></span></td></tr>
          <tr id="amountUsageRow"><th>Amount Due</th><td><span id="amountUsage"></span></td></tr>
          <tr id="prevBalanceRow"><th>Previous Balance (Sheet)</th><td><span id="prevBalance"></span></td></tr>
          <tr><th>Current Balance (Total Due)</th><td><span id="currentBalance" class="total-due-highlight"></span></td></tr>
        </table>

        <div class="form-group">
           <label>Payment Amount</label>
          <input type="number" id="paymentAmount" class="form-control" placeholder="Enter amount">
        </div>
        <button id="submitPayment" class="btn">Submit Payment</button>
        <button id="newPaymentBtn2" class="btn">New Payment</button>
        <div id="paymentStatus" class="status-message"></div>
      </div>

      <div id="receiptContainer" class="hidden">
        <div id="receipt"></div>
        <button id="sharePdfBtn" class="btn">Share PDF Receipt</button>
        <button id="printReceiptBtn" class="btn">Print Receipt</button>
        <button id="newPaymentBtn" class="btn">New Payment</button>
      </div>
    </div>

    <div id="clientsTab" class="tab-content hidden">
      <h2>All Clients</h2>
      <p>Total Last Payment Amount: <strong id="totalLastPaymentAmount">0.00</strong></p>

      <div class="filter-group">
        <div class="filter-item">
            <label for="allClientsSearch">Search Client Name:</label>
            <input type="text" id="allClientsSearch" class="form-control" placeholder="Filter by client name...">
         </div>
        <div class="filter-item">
            <label for="lastPaidByFilter">Last Paid By:</label>
            <input type="text" id="lastPaidByFilter" class="form-control" placeholder="Filter by collector...">
        </div>
        <div class="filter-item">
            <label for="lastPaymentFilter">Last Payment:</label>
            <select id="lastPaymentFilter" class="form-control">
                 <option value="all">All</option>
                <option value="zero">Zero Value</option>
                <option value="non-zero">Non-Zero Value</option>
            </select>
        </div>
      </div>

      <div class="summary-stats">
          <p class="font-bold text-lg">
             Total Visible Records: <span id="visibleRecordsCount">0</span>
          </p>
          <div class="grid">
              <p>Total Current Balance: <strong id="totalCurrentBalance">0.00</strong></p>
              <p>Total Last Payment: <strong id="totalLastPayment">0.00</strong></p>
              <p>Total New Balance: <strong id="totalNewBalance">0.00</strong></p>
          </div>
       </div>

      <div style="max-height: 500px;
      overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th class="client-col">Client</th>
              <th class="num-col">Monthly Fee</th>
              <th class="num-col">Amount Due</th>
              <th class="num-col">Prev Bal</th>
               <th class="num-col">Current Bal (Total Due)</th>
              <th class="num-col">Last Payment Amt</th>
              <th class="num-col">Balance After Payment</th>
              <th class="paid-by-col">Last Paid By</th>
              <th class="action-col">Action</th>
            </tr>
          </thead>
          <tbody id="clientsList"></tbody>
        </table>
      </div>
    </div>

    <div id="paymentsListTab" class="tab-content hidden">
      <h2>Payments History</h2>
      
      <div class="filters">
        <div class="filter-item">
          <label for="filterClient">Client Name</label>
          <input type="text" id="filterClient" class="form-control" placeholder="Filter by Client">
         </div>
        <div class="filter-item">
          <label for="filterUser">User</label>
          <input type="text" id="filterUser" class="form-control" placeholder="Filter by User">
        </div>
        <div class="filter-item">
          <label for="filterFromDate">From Date</label>
          <input type="date" id="filterFromDate" class="form-control">
        </div>
        <div class="filter-item">
             <label for="filterToDate">To Date</label>
          <input type="date" id="filterToDate" class="form-control">
        </div>
        <div class="filter-item">
          <button id="resetFiltersBtn" class="btn">Reset Filters</button>
        </div>
        <!-- NEW PDF REPORT BUTTON -->
        <div class="filter-item">
          <button id="generateReportBtn" class="btn" style="background: #28a745;">ğŸ“Š Generate PDF Report</button>
        </div>
      </div>

           <div id="paymentsSummary">Total Payment Amount: 0.00 | Records: 0</div>
      
      <!-- NEW REPORT STATUS MESSAGE -->
      <div id="reportStatus" class="status-message" style="display: none;"></div>

      <div style="max-height: 500px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>Payment ID</th>
              <th>Client Name</th>
              <th>Date Entered</th>
              <th>User</th>
              <th>Previous Balance</th>
              <th>Total Due Before</th>
              <th>Payment Amount</th>
              <th>New Balance</th>
              <th>Action</th>
            </tr>
          </thead>
           <tbody id="paymentsTableBody"></tbody>
            </table> <!-- Added missing closing table tag -->
              </div> <!-- Added missing closing div for payments list table container -->
                </div> <!-- Added missing closing div for paymentsListTab -->
   <div id="usersTab" class="tab-content hidden">
      <h2>User Management</h2>
      
      <div class="mb-4">
        <h3>Create New User</h3>
        <form id="createUserForm">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="newUsername" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="newPassword" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="newFullName" class="form-control">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="newIsAdmin"> Is Admin
            </label>
          </div>
          <button type="submit" class="btn">Create User</button>
        </form>
        <div id="userCreateStatus" class="status-message"></div>
      </div>
      
      <div class="mb-4">
        <h3>Existing Users</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Full Name</th>
              <th>Admin</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersListTable">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>
    </div> <!-- End of usersTab -->
  </div> <!-- End of mainApp container -->

  <script>
    
    // Add this at the VERY TOP of your <script> tag
    // Detect mobile vs desktop
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    console.log('Is Mobile:', isMobile);

    // Set API URL based on access method - ONLY ONE DECLARATION
    // let API_BASE_URL;
    // if (window.location.hostname === '192.168.1.27') {
    //     API_BASE_URL = 'http://192.168.1.27:8000/api';
    // } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    //     API_BASE_URL = 'http://localhost:8000/api';
    // } else {
        // Try to auto-detect
    //     const protocol = window.location.protocol;
    //     const hostname = window.location.hostname;
   //      API_BASE_URL = `${protocol}//${hostname}:8000/api`;
   //  }


let API_BASE_URL;
if (window.location.protocol.startsWith('http')) {
    API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;
} else {
    API_BASE_URL = 'http://localhost:8000/api';
}



    console.log('Using API URL:', API_BASE_URL);

    let currentClient = null;
    let loggedInUser = null;
    let allClientsData = [];
    let allPaymentsData = [];
    let receiptHeaderFromSheet = '';

    // Helper function for API calls with better error handling
    async function apiCall(endpoint, options = {}) {
        try {
            // Use the already defined API_BASE_URL
            const url = `${API_BASE_URL}${endpoint}`;
            console.log('API Call to:', url);
            
            // Add CORS mode for mobile
            const fetchOptions = {
                mode: 'cors', // Important for mobile
                credentials: 'include', // Include cookies if needed
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...options.headers
                },
                ...options
            };
            
            // Add timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            fetchOptions.signal = controller.signal;
            
            const response = await fetch(url, fetchOptions);
            clearTimeout(timeoutId);
            
         if (!response.ok) {
                    // Try to get error message - clone the response first
                    let errorMessage = `HTTP ${response.status}`;
                    
                    // Clone the response to read it multiple times
                    const responseClone = response.clone();
                    
                    try {
                        const errorData = await responseClone.json();
                        if (errorData && errorData.error) {
                            errorMessage = errorData.error;
                        } else if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // If not JSON, get text from original response
                        try {
                            errorMessage = await response.text();
                        } catch (textError) {
                            // If we can't read text either, use status
                            errorMessage = `HTTP ${response.status}`;
                        }
                    }
                    throw new Error(errorMessage);
                }
                            
            return await response.json();
            
        } catch (error) {
            console.error('API Call Failed:', endpoint, error);
            
            // User-friendly error messages
            if (error.name === 'AbortError') {
                throw new Error('Request timeout. Server might be busy.');
            } else if (error.message.includes('Failed to fetch') || 
                    error.message.includes('NetworkError')) {
                throw new Error('Network error. Check connection and try again.');
            } else if (error.message.includes('CORS')) {
                throw new Error('Cross-origin error. Try refreshing the page.');
            } else {
                throw error;
            }
        }
    }
    

    // ====== CONNECTION TEST ======
    async function testConnection() {
        try {
            console.log('Testing connection to server...');
            const health = await apiCall('/health');
            console.log('âœ… Connection successful:', health);
            return true;
        } catch (error) {
            console.error('âŒ Connection failed:', error);
            
            // Show connection error to user
            const statusEl = document.getElementById('loginStatus') || 
                            document.getElementById('paymentStatus') ||
                            document.createElement('div');
            
            statusEl.innerHTML = `
                <div class="status-error">
                    <strong>Connection Error:</strong> ${error.message}<br>
                    Please check:<br>
                    1. Flask server is running<br>
                    2. Mobile is on same WiFi<br>
                    3. Try: http://192.168.1.27:8000/api/health
                </div>
            `;
            statusEl.style.display = 'block';
            
            return false;
        }
    }

    // Test connection on page load
    window.addEventListener('load', async () => {
        console.log('Page loaded, testing connection...');
        await testConnection();
    });

    // Load app settings
    async function loadAppSettings() {
        try {
            const settings = await apiCall('/settings');
            // Update page title
            const titleElement = document.querySelector('h1');
            if (titleElement) {
                titleElement.innerHTML = `Generator Subscription Payment **${settings.headerTitle}**`;
            }
            // Store receipt header
            receiptHeaderFromSheet = settings.receiptHeader;
            window.receiptHeaderFromSheet = settings.receiptHeader;
        } catch (error) {
            console.error('Failed to load settings:', error);
            receiptHeaderFromSheet = new Date().toLocaleDateString();
            window.receiptHeaderFromSheet = receiptHeaderFromSheet;
        }
    }

    // ====== MAIN APP INITIALIZATION ======
    function initApp() {
        console.log('Initializing app...');
        
        // Check if all required elements exist
        const requiredElements = ['loginBtn', 'username', 'password', 'loginStatus'];
        for (const id of requiredElements) {
            const el = document.getElementById(id);
            console.log(`Element #${id}:`, el ? 'Found' : 'NOT FOUND');
            if (!el) {
                console.error(`CRITICAL: Element #${id} not found!`);
            }
        }
        
        // Check auth
        apiCall('/auth/check').then(result => {
            console.log('Auth check result:', result);
            
            if (!result.hasUsersSheet) {
                console.log('No users required, auto-login as guest');
                
                // Try auto-login
                setTimeout(async () => {
                    try {
                        const loginResult = await apiCall('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify({ username: 'guest', password: 'guest' })
                        });
                        
                        if (loginResult.success) {
                            loggedInUser = loginResult.user;
                            document.getElementById('loginContainer').classList.add('hidden');
                            document.getElementById('mainApp').classList.remove('hidden');
                            
                            await loadAppSettings();
                            await loadClients();
                            await loadPaymentsList();
                            
                            console.log('Auto-login successful');
                        }
                    } catch (error) {
                        console.log('Auto-login failed, manual login required');
                    }
                }, 1000);
            }
        }).catch(error => {
            console.error('Auth check failed:', error);
        });

        setupLogin();
        setupTabs();
        setupSearch();
        setupPaymentForm();
        setupReceipt();
        setupAllClientsFilters();
        setupPaymentsListFilters();
        setupPDFReport();
        
        console.log('App initialization complete');
    }

    function setupLogin() {
        console.log('Setting up login...');
        
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        if (!loginBtn) {
            console.error('Login button not found!');
            return;
        }
        
        // Remove any existing listeners
        const newLoginBtn = loginBtn.cloneNode(true);
        loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
        
        // Add click listener to NEW button
        document.getElementById('loginBtn').addEventListener('click', async function(e) {
            console.log('Login button clicked!');
            e.preventDefault();
            e.stopPropagation();
            
            await handleLogin();
        });
        
        // Also allow Enter key in form fields
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });
        
        // Auto-fill for testing (remove in production)
      //  document.getElementById('username').value = 'guest';
      //  document.getElementById('password').value = 'guest';
        
        console.log('Login setup complete');
    }

    // Also update handleLogin to show more info
    async function handleLogin() {
    console.log('handleLogin() called');
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const statusEl = document.getElementById('loginStatus');

    console.log('Username:', username);

    if (!username || !password) {
        showStatus('Please enter both username and password', 'error', statusEl);
        return;
    }

    showStatus('Authenticating...', 'info', statusEl);
    
    try {
        const result = await apiCall('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ username, password })
        });
        
        console.log('API Response:', result);
        
        if (result.success) {
            // NEW: Store full user object
            loggedInUser = result.user.username;
            window.userInfo = result.user; // Store user info globally
            
            console.log('Login successful, user:', loggedInUser);
            console.log('Full user info:', result.user);
            
            // Hide login, show main app
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Add user info display
            updateUserDisplay(result.user);
            
            // Load app data
            await loadAppSettings();
            await loadClients();
            await loadPaymentsList();
            
            showStatus('Login successful! Welcome ' + result.user.fullName, 'info', statusEl);
            
            // Auto-hide message after 3 seconds
            setTimeout(() => {
                showStatus('', '', statusEl);
            }, 3000);
            
        } else {
            showStatus(result.error || 'Invalid credentials', 'error', statusEl);
        }
    } catch (error) {
        console.error('Login failed:', error);
        showStatus('Login failed: ' + error.message, 'error', statusEl);
    }
}

// NEW: Function to display user info
function updateUserDisplay(userInfo) {
    // Remove any existing user display
    const existingDisplay = document.querySelector('.user-display');
    if (existingDisplay) {
        existingDisplay.remove();
    }
    
    // Create new display
    const userDisplay = document.createElement('div');
    userDisplay.className = 'user-display';
    userDisplay.style.cssText = `
        margin-left: auto;
        margin-right: 15px;
        display: flex;
        align-items: center;
        color: #555;
        font-size: 14px;
    `;
    
    userDisplay.innerHTML = `
        <span>ğŸ‘¤ ${userInfo.fullName}</span>
        ${userInfo.isAdmin ? '<span style="margin-left: 8px; background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">Admin</span>' : ''}
    `;
    
    // Show/hide Users tab based on admin status
   const usersTabBtn = document.getElementById('usersTabButton');
        if (usersTabBtn) {
            if (userInfo.isAdmin) {
                usersTabBtn.style.display = 'block';
            } else {
                usersTabBtn.style.display = 'none';
            }
        }
    
    // Insert before logout button
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.parentNode.insertBefore(userDisplay, logoutBtn);
}

// Also update the logout function
document.getElementById('logoutBtn').addEventListener('click', function() {
    handleLogout();
});

function handleLogout() {
    loggedInUser = null;
    window.userInfo = null;
    
    // Remove user display
    const userDisplay = document.querySelector('.user-display');
    if (userDisplay) {
        userDisplay.remove();
    }
    
    // Show login, hide main app
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginContainer').classList.remove('hidden');
    
    // Clear form fields
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('loginStatus').textContent = '';
    
    // Reset any payment form
    resetPaymentForm();
}

 //   function handleLogout() {
 //       loggedInUser = null;
 //       document.getElementById('mainApp').classList.add('hidden');
//        document.getElementById('loginContainer').classList.remove('hidden');
 //       document.getElementById('username').value = '';
 //       document.getElementById('password').value = '';
//        document.getElementById('loginStatus').textContent = '';
 //       showStatus('', '', document.getElementById('paymentStatus'));
 //   }

function setupTabs() {
    console.log('Setting up tabs...');
    
    document.querySelectorAll('.tab-button').forEach(btn => {
        console.log('Adding click handler to:', btn.textContent);
        
        btn.addEventListener('click', function() {
            console.log('Tab button clicked:', this.textContent);
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active to clicked button
            this.classList.add('active');
            
            const tabId = this.getAttribute('data-tab');
            console.log('Switching to tab:', tabId);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                console.log('Tab shown:', tabId);
            } else {
                console.error('Tab not found:', tabId);
            }
            
            // Load data for each tab when clicked
            if (tabId === 'clientsTab') {
                loadClients();
            } else if (tabId === 'paymentTab') {
                resetPaymentForm();
            } else if (tabId === 'paymentsListTab') {
                loadPaymentsList();
            } else if (tabId === 'usersTab') {
                console.log('Loading users...');
                loadUsers();
            }
        });
    });
}

    function setupSearch() {
        const searchInput = document.getElementById('clientSearch');
        const resultsDiv = document.getElementById('searchResults');
        
        searchInput.addEventListener('input', debounce(async () => {
            const term = searchInput.value.trim();
            if (term.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'none';
                document.getElementById('paymentForm').classList.add('hidden');
                return;
            }

            try {
                const clients = await apiCall(`/clients/search?q=${encodeURIComponent(term)}`);
                
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'block';

                if (clients.length === 0) {
                    resultsDiv.innerHTML = '<div class="client-result">No matching clients found</div>';
                    return;
                }

                clients.forEach(client => {
                    const div = document.createElement('div');
                    div.textContent = `${client.name} (Balance: ${client.currentBalance.toFixed(2)})`;
                    div.className = 'client-result';
                    div.addEventListener('click', () => {
                        searchInput.value = client.name;
                        selectClient(client.name);
                        resultsDiv.innerHTML = '';
                        resultsDiv.style.display = 'none';
                    });
                    resultsDiv.appendChild(div);
                });
            } catch (error) {
                resultsDiv.innerHTML = '<div class="client-result">Error searching clients</div>';
                console.error('Search failed:', error);
            }
        }, 300));

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    }

    async function selectClient(clientName) {
        document.getElementById('clientSearch').value = clientName;
        
        try {
            const client = await apiCall(`/clients/${encodeURIComponent(clientName)}`);
            
            if (!client) {
                showStatus('Client not found', 'error', document.getElementById('paymentStatus'));
                return;
            }

            currentClient = client;

            const isFirstPayment = client.paymentAmt === 0;
            document.getElementById('monthlyFeeRow').style.display = isFirstPayment ? '' : 'none';
            document.getElementById('prevCounterRow').style.display = isFirstPayment ? '' : 'none';
            document.getElementById('currentCounterRow').style.display = isFirstPayment ? '' : 'none';
            document.getElementById('totalUsageRow').style.display = isFirstPayment ? '' : 'none';
            document.getElementById('kiloWattPriceRow').style.display = isFirstPayment ? '' : 'none';
            document.getElementById('amountUsageRow').style.display = isFirstPayment ? '' : 'none';
            document.getElementById('prevBalanceRow').style.display = isFirstPayment ? '' : 'none';

            document.getElementById('clientName').textContent = client.name;
            document.getElementById('monthlyFee').textContent = client.monthlyFee.toFixed(2);
            document.getElementById('prevCounter').textContent = client.prevCounter;
            document.getElementById('currentCounter').textContent = client.currentCounter;
            document.getElementById('totalUsage').textContent = client.totalUsage;
            document.getElementById('kiloWattPrice').textContent = client.kiloWattPrice.toFixed(2);
            document.getElementById('amountUsage').textContent = client.amountUsage.toFixed(2);
            document.getElementById('prevBalance').textContent = client.prevBalance.toFixed(2);
            
            const balanceToShow = isFirstPayment ? client.currentBalance : client.newBalance;
            document.getElementById('currentBalance').textContent = balanceToShow.toFixed(2);

            document.getElementById('paymentAmount').value = '0.00';

            document.getElementById('paymentForm').classList.remove('hidden');
            document.getElementById('receiptContainer').classList.add('hidden');
            showStatus('', '', document.getElementById('paymentStatus'));
        } catch (error) {
            showStatus('Error loading client: ' + error.message, 'error', document.getElementById('paymentStatus'));
        }
    }

    function setupPaymentForm() {
        const submitButton = document.getElementById('submitPayment');
        submitButton.addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentStatusEl = document.getElementById('paymentStatus');

            if (isNaN(amount) || amount <= 0) {
                showStatus('Please enter a valid payment amount', 'error', paymentStatusEl);
                return;
            }

            if (!currentClient) {
                showStatus('No client selected', 'error', paymentStatusEl);
                return;
            }

            if (!loggedInUser) {
                showStatus('User not logged in. Please log in first.', 'error', paymentStatusEl);
                return;
            }

            // Disable the button to prevent multiple clicks
            submitButton.disabled = true;
            showStatus('Processing payment...', 'info', paymentStatusEl);

            const paymentData = {
                clientName: currentClient.name,
                amount: amount,
                loggedInUser: loggedInUser
            };

            try {
                const receiptData = await apiCall('/payments/process', {
                    method: 'POST',
                    body: JSON.stringify(paymentData)
                });
                
                // Re-enable the button
                submitButton.disabled = false;
                
                if (receiptData.error) {
                    showStatus('Error processing payment: ' + receiptData.error, 'error', paymentStatusEl);
                    return;
                }
                
                showStatus('Payment successful!', 'info', paymentStatusEl);
                showReceipt(receiptData);
                await loadClients();
                await loadPaymentsList();
            } catch (error) {
                // Re-enable the button on failure
                submitButton.disabled = false;
                showStatus('Payment failed: ' + error.message, 'error', paymentStatusEl);
            }
        });
    }
    
    function setupReceipt() {
        document.getElementById('sharePdfBtn').addEventListener('click', generateAndSharePdfReceipt);
        document.getElementById('printReceiptBtn').addEventListener('click', () => window.print());
        document.getElementById('newPaymentBtn').addEventListener('click', resetPaymentForm);
        document.getElementById('newPaymentBtn2').addEventListener('click', resetPaymentForm);
        
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('reprint-btn')) {
                handleReprintReceipt(e);
            }
        });
    }

    function containsArabic(text) {
        const arabicRegex = /[\u0600-\u06FF]/;
        return arabicRegex.test(text);
    }

    // UPDATED: Receipt text changes as requested
    function showReceipt(data) {
        const receiptEl = document.getElementById('receipt');
        const getReceiptLine = (label, value) => {
            let valueClass = 'receipt-value';
            if (containsArabic(String(value))) {
                valueClass += ' arabic';
            }
            return `
                <div class="receipt-line">
                <span class="receipt-label">${label}</span>
                <span class="${valueClass}">${value}</span>
                </div>
            `;
        };

        const formatCurrency = (number) => {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number);
        };

        if (data.isFirstPayment) {
            // DETAILED receipt for the first payment - UPDATED TEXT
            receiptEl.innerHTML = `
                <div class="receipt-header">Ù…ÙˆÙ„Ø¯Ø§Øª Ø¨ÙŠØµÙˆØ±</div>
                <div class="receipt-header">H D A</div>
                <div class="receipt-header" style="margin-top: 5px;">Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹</div>
                <div class="receipt-header">${receiptHeaderFromSheet}</div>
                <div class="receipt-divider"></div>

                ${getReceiptLine("Ø§Ù„Ø§Ø³Ù…", data.clientName)}
                ${getReceiptLine("Ø§Ù„ØªØ§Ø±ÙŠØ®", data.date)}
                ${getReceiptLine("Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„", data.paymentId)}
                <div class="receipt-divider"></div>
                
                ${getReceiptLine("Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚", data.prevCounter)}
                ${getReceiptLine("Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ", data.currentCounter)}
                ${getReceiptLine("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ", data.totalUsage)}
                ${getReceiptLine("Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙˆØ§Ø·", formatCurrency(data.kiloWattPrice))}
                ${getReceiptLine("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ", formatCurrency(data.amountUsage))}
                ${getReceiptLine("Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠØ©", formatCurrency(data.monthlyFee))}
                ${getReceiptLine("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚", formatCurrency(data.prevBalanceLogged))}
                <div class="receipt-divider"></div>
                
                ${getReceiptLine("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹", formatCurrency(data.totalDueBeforePayment))}
                <div class="receipt-divider"></div>

                ${getReceiptLine("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹", formatCurrency(data.paymentAmount))}
                ${getReceiptLine("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯", formatCurrency(data.newBalance))}
                <div class="receipt-divider"></div>

                <div style="text-align: center; font-size: 12px; margin-top: 5px;">Ù†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ø­Ø³Ù† ØªØ¹Ø§ÙˆÙ†ÙƒÙ…</div>
            `;
        } else {
            // SIMPLIFIED receipt for subsequent payments - UPDATED TEXT
            receiptEl.innerHTML = `
                <div class="receipt-header">Ù…ÙˆÙ„Ø¯Ø§Øª Ø¨ÙŠØµÙˆØ±</div>
                <div class="receipt-header">H D A</div>
                <div class="receipt-header" style="margin-top: 5px;">Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹</div>
                <div class('receipt-header')>${receiptHeaderFromSheet}</div>
                <div class="receipt-divider"></div>

                ${getReceiptLine("Ø§Ù„Ø§Ø³Ù…", data.clientName)}
                ${getReceiptLine("Ø§Ù„ØªØ§Ø±ÙŠØ®", data.date)}
                ${getReceiptLine("Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„", data.paymentId)}
                <div class="receipt-divider"></div>

                ${getReceiptLine("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹", formatCurrency(data.totalDueBeforePayment))}
                <div class="receipt-divider"></div>
                
                ${getReceiptLine("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹", formatCurrency(data.paymentAmount))}
                ${getReceiptLine("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯", formatCurrency(data.newBalance))}
                <div class="receipt-divider"></div>

                <div style="text-align: center; font-size: 12px; margin-top: 5px;">Ù†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ø­Ø³Ù† ØªØ¹Ø§ÙˆÙ†ÙƒÙ…</div>
            `;
        }
        
        document.getElementById('paymentForm').classList.add('hidden');
        document.getElementById('receiptContainer').classList.remove('hidden');
    }

    // FIXED: PDF filename generation
    async function generateAndSharePdfReceipt() {
        const receiptElement = document.getElementById('receipt');
        
        let clientName = "Unknown";
        if (currentClient && currentClient.name) {
            clientName = currentClient.name;
        } else {
            const receiptLines = receiptElement.querySelectorAll('.receipt-line');
            for (const line of receiptLines) {
                const label = line.querySelector('.receipt-label');
                const value = line.querySelector('.receipt-value');
                if (label && value && label.textContent.includes('Ø§Ù„Ø§Ø³Ù…')) {
                    clientName = value.textContent.trim();
                    break;
                }
            }
        }

        const cleanClientName = clientName.replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\u0020-\u007E]/g, '_');
        const dateStr = new Date().toISOString().slice(0, 10);
        
        const options = {
            margin: 0,
            filename: `Ø¥ÙŠØµØ§Ù„_${cleanClientName}_${dateStr}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                backgroundColor: '#FFFFFF',
            },
            jsPDF: {
                unit: 'mm',
                format: [80, 297],
                orientation: 'portrait'
            }
        };
        
        try {
            const pdfBlob = await html2pdf().set(options).from(receiptElement).outputPdf('blob');
            if (navigator.share) {
                const file = new File([pdfBlob], options.filename, { type: 'application/pdf' });
                await navigator.share({
                    files: [file],
                    title: 'Payment Receipt',
                    text: 'Here is your payment receipt.'
                });
            } else {
                const url = URL.createObjectURL(pdfBlob);
                window.open(url, '_blank');
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }
        } catch (error) {
            console.error('Error generating or sharing PDF:', error);
            alert('Failed to generate PDF. Please try printing instead or check browser capabilities.');
        }
    }

    function resetPaymentForm() {
        document.getElementById('receiptContainer').classList.add('hidden');
        document.getElementById('paymentForm').classList.add('hidden');
        document.getElementById('clientSearch').value = '';
        document.getElementById('paymentAmount').value = '0.00';
        currentClient = null;
        document.getElementById('clientName').textContent = '';
        document.getElementById('monthlyFee').textContent = '';
        document.getElementById('prevCounter').textContent = '';
        document.getElementById('currentCounter').textContent = '';
        document.getElementById('totalUsage').textContent = '';
        document.getElementById('kiloWattPrice').textContent = '';
        document.getElementById('amountUsage').textContent = '';
        document.getElementById('prevBalance').textContent = '';
        document.getElementById('currentBalance').textContent = '';
        showStatus('', '', document.getElementById('paymentStatus'));
        document.querySelectorAll('.receipt-value.arabic').forEach(el => el.classList.remove('arabic'));
    }


async function loadUsers() {
    console.log('loadUsers called, userInfo:', window.userInfo);
    
    // Check if user is admin
    if (!window.userInfo || !window.userInfo.isAdmin) {
        console.log('User is not admin, hiding users tab');
        
        // Hide Users tab button
        const usersTabBtn = document.getElementById('usersTabButton');
        if (usersTabBtn) {
            usersTabBtn.style.display = 'none';
        }
        
        // Hide Users tab content if visible
        const usersTab = document.getElementById('usersTab');
        if (usersTab && !usersTab.classList.contains('hidden')) {
            // Switch to payment tab
            const paymentTabBtn = document.querySelector('.tab-button[data-tab="paymentTab"]');
            if (paymentTabBtn) {
                paymentTabBtn.click();
            }
        }
        return;
    }
    
    // User is admin - show the tab
    const usersTabBtn = document.getElementById('usersTabButton');
    if (usersTabBtn) {
        usersTabBtn.style.display = 'block';
    }
    
    try {
        console.log('Loading users...');
        
        const users = await apiCall('/users/list');
        
        const tbody = document.getElementById('usersListTable');
        if (!tbody) {
            console.error('Users table body not found');
            return;
        }
        
        tbody.innerHTML = '';
        
        if (!users || users.length === 0 || users.error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: #666;">
                        ${users && users.error ? 'Error: ' + users.error : 'No users found'}
                    </td>
                </tr>
            `;
            return;
        }
        
        // Display users in table
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.username || ''}</td>
                <td>${user.full_name || '-'}</td>
                <td>${user.is_admin ? 'âœ… Yes' : 'âŒ No'}</td>
                <td>${user.last_login || 'Never'}</td>
                <td>
                    <button class="btn btn-sm reset-password-btn" data-username="${user.username}" 
                            style="background: #dc3545; color: white;"
                            ${user.username === window.userInfo.username ? 'disabled' : ''}>
                        Reset Password
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add event listeners for reset password buttons
        document.querySelectorAll('.reset-password-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const username = this.getAttribute('data-username');
                await resetUserPassword(username);
            });
        });
        
    } catch (error) {
        console.error('Error loading users:', error);
        const tbody = document.getElementById('usersListTable');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: red;">
                        Error loading users: ${error.message}
                    </td>
                </tr>
            `;
        }
    }
}

// Function to reset user password
async function resetUserPassword(username) {
    if (!confirm(`Reset password for user "${username}" to "password123"?`)) {
        return;
    }
    
    try {
        const result = await apiCall('/users/create', {
            method: 'POST',
            body: JSON.stringify({
                username: username,
                password: 'password123',
                fullName: username,
                isAdmin: false
            })
        });
        
        if (result.success) {
            alert(`âœ… Password for ${username} has been reset to "password123"`);
            // Reload the users list
            await loadUsers();
        } else {
            alert(`âŒ Error: ${result.error}`);
        }
    } catch (error) {
        alert(`âŒ Error: ${error.message}`);
    }
}


// Handle create user form submission
document.getElementById('createUserForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const fullName = document.getElementById('newFullName').value.trim();
    const isAdmin = document.getElementById('newIsAdmin').checked;
    
    if (!username || !password) {
        alert('Username and password are required');
        return;
    }
    
    if (password.length < 4) {
        alert('Password must be at least 4 characters');
        return;
    }
    
    const statusEl = document.getElementById('userCreateStatus');
    showStatus('Creating user...', 'info', statusEl);
    
    try {
        const result = await apiCall('/users/create', {
            method: 'POST',
            body: JSON.stringify({
                username: username,
                password: password,
                fullName: fullName,
                isAdmin: isAdmin
            })
        });
        
        if (result.success) {
            showStatus('âœ… User created successfully!', 'info', statusEl);
            // Clear form
            document.getElementById('createUserForm').reset();
            // Refresh users list
            await loadUsers();
            
            // Auto-clear success message after 3 seconds
            setTimeout(() => {
                showStatus('', '', statusEl);
            }, 3000);
        } else {
            showStatus('âŒ Error: ' + result.error, 'error', statusEl);
        }
    } catch (error) {
        showStatus('âŒ Error creating user: ' + error.message, 'error', statusEl);
    }
});


    async function loadClients() {
        const clientsTab = document.getElementById('clientsTab');
        let statusEl = clientsTab.querySelector('.status-message');
        if (!statusEl) {
            statusEl = document.createElement('div');
            statusEl.className = 'status-message status-info';
            clientsTab.prepend(statusEl);
        }
        
        showStatus('Loading clients...', 'info', statusEl);
        
        try {
            allClientsData = await apiCall('/clients');
            displayFilteredClients();
            showStatus(`Loaded ${allClientsData.length} clients`, 'info', statusEl);

            // Get total last payment amount
            try {
                const totalResult = await apiCall('/payments/total-last');
                document.getElementById('totalLastPaymentAmount').textContent = (totalResult.total || 0).toFixed(2);
            } catch (error) {
                console.error("Error fetching total last payment amount:", error);
                document.getElementById('totalLastPaymentAmount').textContent = 'Error';
            }

        } catch (error) {
            showStatus('Error loading clients: ' + error.message, 'error', statusEl);
            console.error('Client load error:', error);
        }
    }

    function setupAllClientsFilters() {
        document.getElementById('allClientsSearch').addEventListener('input', debounce(displayFilteredClients, 200));
        document.getElementById('lastPaymentFilter').addEventListener('change', displayFilteredClients);
        document.getElementById('lastPaidByFilter').addEventListener('input', debounce(displayFilteredClients, 200));
    }
    
    function displayFilteredClients() {
        const searchTerm = document.getElementById('allClientsSearch').value.toLowerCase();
        const lastPaymentFilter = document.getElementById('lastPaymentFilter').value;
        const lastPaidByFilterTerm = document.getElementById('lastPaidByFilter').value.toLowerCase();
        const tbody = document.getElementById('clientsList');
        tbody.innerHTML = '';
        
        let totalCurrentBalance = 0;
        let totalLastPayment = 0;
        let totalNewBalance = 0;
        
        const filteredClients = allClientsData.filter(client => {
            const clientNameMatch = client.name.toLowerCase().includes(searchTerm);
            
            let lastPaymentMatch = true;
            if (lastPaymentFilter === 'zero') {
                lastPaymentMatch = client.paymentAmt === 0;
            } else if (lastPaymentFilter === 'non-zero') {
                lastPaymentMatch = client.paymentAmt > 0;
            }

            const lastPaidByMatch = client.lastPaidBy.toLowerCase().includes(lastPaidByFilterTerm);

            return clientNameMatch && lastPaymentMatch && lastPaidByMatch;
        });
        
        if (filteredClients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No matching clients found.</td></tr>';
            document.getElementById('totalCurrentBalance').textContent = '0.00';
            document.getElementById('totalLastPayment').textContent = '0.00';
            document.getElementById('totalNewBalance').textContent = '0.00';
            document.getElementById('visibleRecordsCount').textContent = '0';
            return;
        }

        filteredClients.forEach(client => {
            const row = document.createElement('tr');
            row.setAttribute('data-client-name', client.name.toLowerCase());
            row.innerHTML = `
                <td class="client-col">${client.name}</td>
                <td class="num-col">${client.monthlyFee.toFixed(2)}</td>
                <td class="num-col">${client.amountUsage.toFixed(2)}</td>
                <td class="num-col">${client.prevBalance.toFixed(2)}</td>
                <td class="num-col">${client.currentBalance.toFixed(2)}</td>
                <td class="num-col">${client.paymentAmt.toFixed(2)}</td>
                <td class="num-col">${client.newBalance.toFixed(2)}</td>
                <td class="paid-by-col">${client.lastPaidBy}</td>
                <td class="action-col">
                    <button class="btn btn-sm new-payment-btn" data-client-name="${client.name}">New Payment</button>
                </td>
            `;
            tbody.appendChild(row);
            
            totalCurrentBalance += client.currentBalance;
            totalLastPayment += client.paymentAmt;
            totalNewBalance += client.newBalance;
        });

        document.querySelectorAll('.new-payment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const clientName = this.getAttribute('data-client-name');
                document.querySelector('.tab-button[data-tab="paymentTab"]').click();
                document.getElementById('clientSearch').value = clientName;
                selectClient(clientName);
            });
        });
        
        document.getElementById('totalCurrentBalance').textContent = totalCurrentBalance.toFixed(2);
        document.getElementById('totalLastPayment').textContent = totalLastPayment.toFixed(2);
        document.getElementById('totalNewBalance').textContent = totalNewBalance.toFixed(2);
        document.getElementById('visibleRecordsCount').textContent = filteredClients.length;
    }

    async function loadPaymentsList() {
        const paymentsTab = document.getElementById('paymentsListTab');
        let statusEl = paymentsTab.querySelector('.status-message');
        if (!statusEl) {
            statusEl = document.createElement('div');
            statusEl.className = 'status-message status-info';
            paymentsTab.prepend(statusEl);
        }
        
        showStatus('Loading payments...', 'info', statusEl);
        
        try {
            allPaymentsData = await apiCall('/payments');
            applyPaymentsFilters();
            showStatus(`Loaded ${allPaymentsData.length} payments`, 'info', statusEl);
        } catch (error) {
            showStatus('Error loading payments: ' + error.message, 'error', statusEl);
            console.error('Payments load error:', error);
        }
    }

    function setupPaymentsListFilters() {
        document.getElementById('filterClient').addEventListener('input', debounce(applyPaymentsFilters, 200));
        document.getElementById('filterUser').addEventListener('input', debounce(applyPaymentsFilters, 200));
        document.getElementById('filterFromDate').addEventListener('change', applyPaymentsFilters);
        document.getElementById('filterToDate').addEventListener('change', applyPaymentsFilters);
        document.getElementById('resetFiltersBtn').addEventListener('click', resetPaymentsFilters);
    }

    // NEW: Setup PDF Report functionality
    function setupPDFReport() {
        document.getElementById('generateReportBtn').addEventListener('click', generatePDFReportHandler);
    }

    // NEW: PDF Report Handler
    async function generatePDFReportHandler() {
        const reportStatusEl = document.getElementById('reportStatus');
        const generateBtn = document.getElementById('generateReportBtn');
        
        // Get current filter values
        const filters = {
            clientFilter: document.getElementById('filterClient').value,
            userFilter: document.getElementById('filterUser').value,
            fromDate: document.getElementById('filterFromDate').value,
            toDate: document.getElementById('filterToDate').value
        };
        
        // Show loading state
        generateBtn.disabled = true;
        generateBtn.textContent = 'â³ Generating PDF...';
        showStatus('Generating PDF report...', 'info', reportStatusEl);
        
        try {
            // For now, just show filtered payments in a new window
            applyPaymentsFilters();
            
            // Create HTML content
            const filtered = getFilteredPayments();
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Payments Report</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        h1 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #4CAF50; color: white; }
                        .total-row { font-weight: bold; background-color: #f0f0f0; }
                    </style>
                </head>
                <body>
                    <h1>Generator Payments Report</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    <p>Total Records: ${filtered.length}</p>
            `;
            
            // Add table
            htmlContent += `
                <table>
                    <thead>
                        <tr>
                            <th>Payment ID</th>
                            <th>Client Name</th>
                            <th>Date</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>New Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalAmount = 0;
            filtered.forEach(p => {
                totalAmount += p.paymentAmount;
                htmlContent += `
                    <tr>
                        <td>${p.paymentId}</td>
                        <td>${p.clientName}</td>
                        <td>${p.dateEntered}</td>
                        <td>${p.user}</td>
                        <td>${p.paymentAmount.toFixed(2)}</td>
                        <td>${p.newBalance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            htmlContent += `
                        <tr class="total-row">
                            <td colspan="4"><strong>TOTAL:</strong></td>
                            <td><strong>${totalAmount.toFixed(2)}</strong></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </body>
            </html>
            `;
            
            // Open in new window
            const newWindow = window.open();
            newWindow.document.write(htmlContent);
            newWindow.document.close();
            
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸ“Š Generate PDF Report';
            showStatus('Report generated successfully!', 'info', reportStatusEl);
            
            setTimeout(() => {
                showStatus('', '', reportStatusEl);
            }, 3000);
            
        } catch (error) {
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸ“Š Generate PDF Report';
            showStatus('Failed to generate report: ' + error.message, 'error', reportStatusEl);
        }
    }

    function getFilteredPayments() {
        const clientFilter = document.getElementById("filterClient").value.toLowerCase();
        const userFilter = document.getElementById("filterUser").value.toLowerCase();
        const fromDate = document.getElementById("filterFromDate").value;
        const toDate = document.getElementById("filterToDate").value;

        return allPaymentsData.filter(p => {
            const matchClient = p.clientName.toLowerCase().includes(clientFilter);
            const matchUser = p.user.toLowerCase().includes(userFilter);
            
            let matchFrom = true;
            let matchTo = true;
            
            if (fromDate) {
                const fromDateObj = new Date(fromDate);
                const paymentDate = new Date(p.dateEntered);
                fromDateObj.setHours(0, 0, 0, 0);
                matchFrom = paymentDate >= fromDateObj;
            }
            
            if (toDate) {
                const toDateObj = new Date(toDate);
                const paymentDate = new Date(p.dateEntered);
                toDateObj.setHours(23, 59, 59, 999);
                matchTo = paymentDate <= toDateObj;
            }

            return matchClient && matchUser && matchFrom && matchTo;
        });
    }

    function applyPaymentsFilters() {
        const filtered = getFilteredPayments();
        const tbody = document.getElementById("paymentsTableBody");
        tbody.innerHTML = "";
        
        let total = 0;
        
        if (filtered.length === 0) {
            tbody.innerHTML = "<tr><td colspan='9'>No matching payments found.</td></tr>";
        } else {
            filtered.forEach(p => {
                total += parseFloat(p.paymentAmount);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${p.paymentId}</td>
                    <td>${p.clientName}</td>
                    <td class="date-cell">${p.dateEntered}</td>
                    <td>${p.user}</td>
                    <td>${parseFloat(p.previousBalance).toFixed(2)}</td>
                    <td>${parseFloat(p.totalDueBeforePayment).toFixed(2)}</td>
                    <td>${parseFloat(p.paymentAmount).toFixed(2)}</td>
                    <td>${parseFloat(p.newBalance).toFixed(2)}</td>
                    <td><button class="btn btn-sm reprint-btn" data-payment-id="${p.paymentId}">Reprint</button></td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.reprint-btn').forEach(button => {
                button.addEventListener('click', handleReprintReceipt);
            });
        }

        const formattedTotal = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(total);
        
        document.getElementById("paymentsSummary").textContent = `Total Payment Amount: ${formattedTotal} | Records: ${filtered.length}`;
    }

    async function handleReprintReceipt(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const button = event.target.closest('.reprint-btn');
        if (!button) return;
        
        const paymentId = button.getAttribute('data-payment-id');
        if (!paymentId) {
            alert('Payment ID not found for reprint');
            return;
        }

        const paymentsTab = document.getElementById('paymentsListTab');
        let statusEl = paymentsTab.querySelector('.status-message');
        if (!statusEl) {
            statusEl = document.createElement('div');
            statusEl.className = 'status-message status-info';
            paymentsTab.prepend(statusEl);
        }
        
        showStatus('Generating receipt for reprint...', 'info', statusEl);
        
        try {
            const receiptData = await apiCall(`/receipt/by-id/${paymentId}`);
            
            if (receiptData.error) {
                showStatus('Error: ' + receiptData.error, 'error', statusEl);
                return;
            }
            
            currentClient = { name: receiptData.clientName };
            showReceipt(receiptData);

            document.querySelector('.tab-button[data-tab="paymentTab"]').click();
            document.getElementById('receiptContainer').classList.remove('hidden');

            showStatus('Receipt ready for printing/sharing', 'info', statusEl);
        } catch (error) {
            showStatus('Error: ' + error.message, 'error', statusEl);
            console.error('Reprint error:', error);
        }
    }
    
    function resetPaymentsFilters() {
        document.getElementById("filterClient").value = "";
        document.getElementById("filterUser").value = "";
        document.getElementById("filterFromDate").value = "";
        document.getElementById("filterToDate").value = "";
        applyPaymentsFilters();
    }

    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    function showStatus(message, type, element) {
        const el = element || document.getElementById('loginStatus');
        el.textContent = message;
        el.className = `status-message status-${type}`;
        if (message) {
            el.style.display = 'block';
        } else {
            el.style.display = 'none';
        }
    }

    // Initialize the app when page loads
    document.addEventListener('DOMContentLoaded', initApp);
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        
        // Sometimes buttons inside forms submit the form
        const loginForm = document.querySelector('.login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submit prevented');
                return false;
            });
        }
        
        // Make sure button is clickable
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            loginBtn.style.pointerEvents = 'auto';
            loginBtn.style.cursor = 'pointer';
            
            // Double-check click handler
            loginBtn.onclick = function(e) {
                console.log('Direct onclick fired');
                e.preventDefault();
                handleLogin();
                return false;
            };
        }
        
        // Initialize app
        setTimeout(initApp, 100);
    });


  </script>
</body>
</html>